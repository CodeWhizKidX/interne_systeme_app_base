# Google OAuth 2.0 セキュリティ設定ガイド

## Client IDの漏洩について

### 重要なポイント

1. **Client IDは公開情報として設計されています**
   - フロントエンドのJavaScriptに含まれるため、誰でも見ることができます
   - これはOAuth 2.0の仕様上、正常な動作です

2. **Client IDだけでは攻撃できません**
   - Client IDだけでは、トークンを取得することはできません
   - 重要なのは、**承認済みのドメイン設定**です

## セキュリティ対策

### 1. Google Cloud Consoleでの設定（最重要）

Google Cloud Consoleで以下の設定を**厳密に**行ってください：

#### 承認済みのJavaScript生成元（Authorized JavaScript origins）
```
https://your-domain.com
https://www.your-domain.com
http://localhost:5173  (開発環境のみ)
```

⚠️ **重要**: ワイルドカード（`*`）は使用しないでください

#### 承認済みのリダイレクトURI（Authorized redirect URIs）
```
https://your-domain.com/callback
http://localhost:5173/callback  (開発環境のみ)
```

⚠️ **重要**: 正確なURIを指定してください

### 2. バックエンドでの保護

現在の実装では、以下の保護が行われています：

1. **CORS設定**: 許可されたオリジンのみアクセス可能
2. **組織ドメインチェック**: 許可された組織ドメインのユーザーのみアクセス可能
3. **トークン検証**: Googleの公開鍵でIDトークンを検証

### 3. 追加のセキュリティ対策（推奨）

以下の対策を追加することを推奨します：

#### A. リファラー/オリジン検証の強化
- リクエストのOrigin/Refererヘッダーを検証
- 許可されたドメインからのリクエストのみ受け付ける

#### B. レート制限
- 同一IPアドレスからの過剰なリクエストを制限
- ブルートフォース攻撃を防止

#### C. トークンの有効期限チェック
- IDトークンの有効期限を厳密にチェック
- 期限切れトークンは即座に拒否

## 攻撃シナリオと対策

### シナリオ1: Client IDが漏洩した場合

**攻撃**: 悪意のあるユーザーがClient IDを使って別のサイトから認証を試みる

**対策**: 
- Google Cloud Consoleで「承認済みのJavaScript生成元」を厳密に設定
- 許可されていないドメインからのリクエストはGoogleが拒否します

### シナリオ2: トークンの偽造

**攻撃**: 悪意のあるユーザーが偽のIDトークンを作成

**対策**:
- IDトークンはGoogleの秘密鍵で署名されています
- バックエンドでGoogleの公開鍵を使って検証するため、偽造は不可能です

### シナリオ3: 組織外のユーザーがアクセス

**攻撃**: 組織外のGoogleアカウントでログインを試みる

**対策**:
- `ALLOWED_ORGANIZATION_DOMAINS`環境変数で組織ドメインを制限
- 許可されていないドメインのユーザーは403エラーで拒否されます

## 設定チェックリスト

- [ ] Google Cloud Consoleで「承認済みのJavaScript生成元」を設定
- [ ] Google Cloud Consoleで「承認済みのリダイレクトURI」を設定
- [ ] ワイルドカード（`*`）を使用していないことを確認
- [ ] 本番環境のドメインのみを許可
- [ ] `ALLOWED_ORGANIZATION_DOMAINS`環境変数を設定
- [ ] CORS設定で許可されたオリジンのみを指定
- [ ] 定期的にアクセスログを確認

## まとめ

**Client IDが漏洩しても、適切な設定を行っていれば安全です。**

重要なのは：
1. Google Cloud Consoleでの厳密なドメイン設定
2. バックエンドでの組織ドメインチェック
3. CORS設定によるオリジン制限

これらの対策により、Client IDが漏洩しても、許可されていないドメインからは使用できません。
